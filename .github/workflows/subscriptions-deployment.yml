name: Subscriptions Deployment

on:
  push:
    branches:
      - main
    paths:
      - Subscriptions/backends/**/*.tfvars
      - Subscriptions/vars/**/*.tfvars
  workflow_dispatch:
    inputs:
      tfvars_file:
        description: Select tfvars filename to deploy
        required: true
        type: choice
        options:
          - nonprod.tfvars
          - prod1.tfvars

permissions:
  contents: read
  id-token: write

jobs:
  detect:
    runs-on: ubuntu-latest
    outputs:
      has_files: ${{ steps.build.outputs.has_files }}
      files: ${{ steps.build.outputs.files }}
      source: ${{ steps.build.outputs.source }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed tfvars files
        id: changed
        uses: tj-actions/changed-files@v46
        with:
          files: |
            Subscriptions/backends/**/*.tfvars
            Subscriptions/vars/**/*.tfvars

      - name: Build matrix from filenames
        id: build
        shell: bash
        run: |
          set -euo pipefail
          manual_file="${{ inputs.tfvars_file }}"
          changed_files="${{ steps.changed.outputs.all_changed_files }}"

          if [ -n "$manual_file" ]; then
            file_name="$(basename "$manual_file")"
            if [ ! -f "Subscriptions/backends/$file_name" ] || [ ! -f "Subscriptions/vars/$file_name" ]; then
              echo "Input file '$file_name' must exist in both Subscriptions/backends and Subscriptions/vars"
              exit 1
            fi

            echo "has_files=true" >> "$GITHUB_OUTPUT"
            echo "files=[\"$file_name\"]" >> "$GITHUB_OUTPUT"
            echo "source=manual" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [ -z "$changed_files" ]; then
            echo "has_files=false" >> "$GITHUB_OUTPUT"
            echo "files=[]" >> "$GITHUB_OUTPUT"
            echo "source=none" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          files_json="$(
            for path in $changed_files; do
              basename "$path"
            done | sort -u | jq -R . | jq -s .
          )"

          echo "has_files=true" >> "$GITHUB_OUTPUT"
          echo "files=$files_json" >> "$GITHUB_OUTPUT"
          echo "source=changes" >> "$GITHUB_OUTPUT"

      - name: Publish detection summary
        run: |
          {
            echo "## Deployment Input"
            echo
            echo "- Source: ${{ steps.build.outputs.source }}"
            echo "- Files: ${{ steps.build.outputs.files }}"
          } >> "$GITHUB_STEP_SUMMARY"

  deploy:
    runs-on: ubuntu-latest
    needs: detect
    if: needs.detect.outputs.has_files == 'true'
    strategy:
      fail-fast: false
      matrix:
        file: ${{ fromJson(needs.detect.outputs.files) }}
    defaults:
      run:
        working-directory: ./Subscriptions
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - name: Terraform Init
        run: terraform init --backend-config="backends/${{ matrix.file }}"

      - name: Terraform Plan
        run: terraform plan --var-file="vars/${{ matrix.file }}" -out=tfplan

      - name: Terraform Apply
        run: terraform apply -auto-approve tfplan
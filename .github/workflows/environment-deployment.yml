name: Environment Deployment

on:
  workflow_dispatch:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main

permissions:
  contents: read
  id-token: write

jobs:
  detect-folders:
    runs-on: ubuntu-latest
    outputs:
      has_folders: ${{ steps.build.outputs.has_folders }}
      matrix: ${{ steps.build.outputs.matrix }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build folder matrix
        id: build
        shell: bash
        run: |
          set -euo pipefail

          folders_json="$(
            find environment/dev environment/prod -mindepth 1 -maxdepth 1 -type d -print 2>/dev/null \
              | sort -u \
              | jq -R . \
              | jq -s .
          )"

          if [ "$folders_json" = "[]" ]; then
            echo "has_folders=false" >> "$GITHUB_OUTPUT"
            echo "matrix=[]" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "has_folders=true" >> "$GITHUB_OUTPUT"
          echo "matrix=$folders_json" >> "$GITHUB_OUTPUT"

  deploy:
    runs-on: ubuntu-latest
    needs: detect-folders
    if: needs.detect-folders.outputs.has_folders == 'true'
    environment: ${{ startsWith(matrix.tf_dir, 'environment/prod/') && 'prod' || 'dev' }}
    strategy:
      fail-fast: false
      matrix:
        tf_dir: ${{ fromJson(needs.detect-folders.outputs.matrix) }}
    defaults:
      run:
        working-directory: ${{ matrix.tf_dir }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - name: Terraform Init
        env:
          ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
        run: |
          state_key="$(echo "${{ matrix.tf_dir }}" | tr '/' '-')-terraform.tfstate"
          terraform init \
            -backend-config="resource_group_name=${{ secrets.TFSTATE_RESOURCE_GROUP }}" \
            -backend-config="storage_account_name=${{ secrets.TFSTATE_STORAGE_ACCOUNT }}" \
            -backend-config="container_name=${{ secrets.TFSTATE_CONTAINER }}" \
            -backend-config="key=$state_key"

      - name: Terraform Plan
        env:
          ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
        run: terraform plan -out=tfplan

      - name: Terraform Apply
        env:
          ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
        run: terraform apply -auto-approve tfplan